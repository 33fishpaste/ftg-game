<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>格闘ゲームタイムライン</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-section {
            margin-bottom: 20px;
        }
        .input-section input {
            padding: 8px;
            margin: 5px;
            width: 200px;
        }
        .battle-log {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
				.character-container {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin: 20px 0;
}

.player-section {
    flex: 1;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

h2 {
    text-align: center;
}

label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
}

input,
select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

img {
    display: block;
    margin: 10px auto;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 768px) {
    .character-container {
        flex-direction: column;
    }

    .player-section {
        margin-bottom: 20px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>格闘ゲームタイムライン</h1>
        <div class="character-container">
    <!-- プレイヤー1 -->
    <div class="player-section" id="player1Section">
        <h2>プレイヤー1</h2>
        <label for="player1CharacterSelect">キャラクター:</label>
        <select id="player1CharacterSelect" onchange="updatePlayerInfo('player1')">
            <option value="">-- キャラクターを選択 --</option>
            <option value="サナギ体">サナギ体</option>
            <option value="アラクネアワーム">アラクネアワーム</option>
            <option value="ベルバーワーム">ベルバーワーム</option>
            <option value="フォルミュカアルビュスワーム">フォルミュカアルビュスワーム</option>
            <option value="ジオフィリドワーム">ジオフィリドワーム</option>
            <option value="アキャリナワーム">アキャリナワーム</option>
            <option value="ランピリスワーム">ランピリスワーム</option>
            <option value="コキリアワーム">コキリアワーム</option>
            <option value="エピラクナワーム">エピラクナワーム</option>
            <option value="キャマラスワーム">キャマラスワーム</option>
            <option value="ジェノミアスワーム">ジェノミアスワーム</option>
            <option value="ミュスカワーム">ミュスカワーム</option>
            <option value="ビエラワーム">ビエラワーム</option>
            <option value="プレクスワーム">プレクスワーム</option>
            <option value="レプトーフィスワーム">レプトーフィスワーム</option>
            <option value="グリラスワーム">グリラスワーム</option>
            <option value="カッシスワーム">カッシスワーム</option>
            <option value="シシーラワーム">シシーラワーム</option>
            <option value="フォリアタスワーム">フォリアタスワーム</option>
						<option value="コレオプテラワーム">コレオプテラワーム</option>
            <option value="ベルクリネタスワーム">ベルクリネタスワーム</option
            <!-- 他のキャラクターを追加 -->
        </select>

        <label for="player1GenderSelect">性別:</label>
        <select id="player1GenderSelect" onchange="updatePlayerInfo('player1')">
            <option value="">-- 性別を選択 --</option>
            <option value="雄">雄</option>
            <option value="雌">雌</option>
        </select>
				
				<label for="player1TypeSelect">性別:</label>
        <select id="player1TypeSelect" onchange="updatePlayerInfo('player1')">
            <option value="">-- 性格を選択 --</option>
            <option value="好戦的で戦闘狂">好戦的で戦闘狂</option>
            <option value="好戦的で支配的">好戦的で支配的</option>
            <option value="好戦的で紳士的">好戦的で紳士的</option>
			<option value="非好戦的で卑怯">非好戦的で卑怯</option>
			<option value="非好戦的で冷酷">非好戦的で冷酷</option>
			<option value="非好戦的で慈愛">非好戦的で慈愛</option>
        </select>

        <label for="player1Name">自動設定されたキャラクター名:</label>
        <input type="text" id="player1Name" readonly style="background-color: #e9e9e9;">

        <div id="player1CharacterInfo">
            <img id="player1Image" src="" alt="キャラクター画像" style="max-width: 300px; display: none;">
        </div>
				
    <button onclick="setRandomSettings('player1')">ランダム設定</button>
    </div>

    <!-- プレイヤー2 -->
    <div class="player-section" id="player2Section">
        <h2>プレイヤー2</h2>
        <label for="player2CharacterSelect">キャラクター:</label>
        <select id="player2CharacterSelect" onchange="updatePlayerInfo('player2')">
            <option value="">-- キャラクターを選択 --</option>
            <option value="サナギ体">サナギ体</option>
            <option value="アラクネアワーム">アラクネアワーム</option>
            <option value="ベルバーワーム">ベルバーワーム</option>
            <option value="フォルミュカアルビュスワーム">フォルミュカアルビュスワーム</option>
            <option value="ジオフィリドワーム">ジオフィリドワーム</option>
            <option value="アキャリナワーム">アキャリナワーム</option>
            <option value="ランピリスワーム">ランピリスワーム</option>
            <option value="コキリアワーム">コキリアワーム</option>
            <option value="エピラクナワーム">エピラクナワーム</option>
            <option value="キャマラスワーム">キャマラスワーム</option>
            <option value="ジェノミアスワーム">ジェノミアスワーム</option>
            <option value="ミュスカワーム">ミュスカワーム</option>
            <option value="ビエラワーム">ビエラワーム</option>
            <option value="プレクスワーム">プレクスワーム</option>
            <option value="レプトーフィスワーム">レプトーフィスワーム</option>
            <option value="グリラスワーム">グリラスワーム</option>
            <option value="カッシスワーム">カッシスワーム</option>
            <option value="シシーラワーム">シシーラワーム</option>
            <option value="フォリアタスワーム">フォリアタスワーム</option>
						<option value="コレオプテラワーム">コレオプテラワーム</option>
            <option value="ベルクリネタスワーム">ベルクリネタスワーム</option>
            <!-- 他のキャラクターを追加 -->
        </select>

        <label for="player2GenderSelect">性別:</label>
        <select id="player2GenderSelect" onchange="updatePlayerInfo('player2')">
            <option value="">-- 性別を選択 --</option>
            <option value="雄">雄</option>
            <option value="雌">雌</option>
        </select>
				
				<label for="player2TypeSelect">性別:</label>
        <select id="player2TypeSelect" onchange="updatePlayerInfo('player2')">
            <option value="">-- 性格を選択 --</option>
            <option value="好戦的で戦闘狂">好戦的で戦闘狂</option>
            <option value="好戦的で支配的">好戦的で支配的</option>
            <option value="好戦的で紳士的">好戦的で紳士的</option>
			<option value="非好戦的で卑怯">非好戦的で卑怯</option>
			<option value="非好戦的で冷酷">非好戦的で冷酷</option>
			<option value="非好戦的で慈愛">非好戦的で慈愛</option>
        </select>

        <label for="player2Name">自動設定されたキャラクター名:</label>
        <input type="text" id="player2Name" readonly style="background-color: #e9e9e9;">

        <div id="player2CharacterInfo">
            <img id="player2Image" src="" alt="キャラクター画像" style="max-width: 300px; display: none;">
        </div>
				<button onclick="setRandomSettings('player2')">ランダム設定</button>
    </div>
</div>
        <button onclick="startBattle()">バトル開始</button>
        <textarea id="battleLog" class="battle-log" readonly></textarea>
    </div>
		
		<div class="input-section">
    <h2>バトルログ操作</h2>
    <button onclick="copyBattleLog()">バトルログをコピー</button>
    <textarea id="battleLog" class="battle-log" readonly></textarea>

    <h3>定型文コピー</h3>
    <button onclick="copyTemplateText(1)">定型文1をコピー</button>
    <button onclick="copyTemplateText(2)">定型文2をコピー</button>
    <button onclick="copyTemplateText(3)">定型文3をコピー</button>
</div>

    <script>
        class BattleSystem {
            constructor() {
                this.normalTargets = ['頭部', '首', '腕', '胸部', '腹部', '腿'];
                this.normalAttacks = ['特技1', '特技2', '蹴り', '殴り'];
                this.followupTargets = ['頭部'];
                this.followupAttacks = ['特技1', '特技2', '組み技'];
                this.finishTargets = ['頭部', '頭部'];
                this.finishAttacks = ['関節技', '恥辱技', 'ゴア技'];
				this.followupCombos = [
    { target: '首', attack: '関節技' },
    { target: '腿', attack: '関節技' },
    { target: '腕', attack: '関節技' },
    { target: '頭部', attack: '膝圧迫技' },
    { target: '頭部', attack: '手技' },
    { target: '頭部', attack: '特技1' },
    { target: '頭部', attack: '特技2' }
];

this.finishCombos = [
    { target: '頭部', attack: '恥辱技(手技)' },
    { target: '頭部', attack: 'ゴア技(膝圧迫技)' }
];
                this.logCounter = 1;
                this.rounds = {p1: 0, p2: 0};
                this.previousSecondHitFailed = {
                    p1: false,
                    p2: false
                };
            }

            getRandomItem(array, excludeItems = []) {
                let availableItems = array.filter(item => !excludeItems.includes(item));
                return availableItems[Math.floor(Math.random() * availableItems.length)];
            }

            getRandomItems(array, count, excludeItems = []) {
                let result = [];
                let available = [...array];
                for (let i = 0; i < count; i++) {
                    let index = Math.floor(Math.random() * available.length);
                    let item = available.splice(index, 1)[0];
                    if (!excludeItems.includes(item)) {
                        result.push(item);
                    }
                }
                return result;
            }

            addLog(message) {
                let logElement = document.getElementById('battleLog');
                let formattedMessage = `${String(this.logCounter).padStart(2, '0')}: ${message}\n`;
                logElement.value += formattedMessage;
                logElement.scrollTop = logElement.scrollHeight;
                this.logCounter++;
            }

            async startBattle() {
                const p1Name = document.getElementById('player1Name').value || 'Player 1';
                const p2Name = document.getElementById('player2Name').value || 'Player 2';
                
                document.getElementById('battleLog').value = '';
                this.logCounter = 1;
                this.rounds = {p1: 0, p2: 0};

                while (this.rounds.p1 < 2 && this.rounds.p2 < 2) {
                    await this.executePreparePhase(p1Name, p2Name);
                }
            }

            async executePreparePhase(p1Name, p2Name) {
                // P1の準備
                let p1Target = this.getRandomItem(this.normalTargets);
                let p1Attacks = this.getRandomItems(this.normalAttacks, 2);
                let p2Guards = this.getRandomItems(this.normalTargets, 2);
                let p2GuardAttacks1 = this.getRandomItems(this.normalAttacks, 2);
                let p2GuardAttacks2 = this.getRandomItems(this.normalAttacks, 2);

                //this.addLog(`${p1Name} 狙う部位：${p1Target} 攻撃方法：1回目${p1Attacks[0]}、2回目${p1Attacks[1]} / ${p2Name} 警戒部位：[${p2Guards.join('、')}] 警戒攻撃方法：1回目[${p2GuardAttacks1.join('、')}] 2回目[${p2GuardAttacks2.join('、')}]`);

                // P2の準備
                let p2Target = this.getRandomItem(this.normalTargets);
                let p2Attacks = this.getRandomItems(this.normalAttacks, 2);
                let p1Guards = this.getRandomItems(this.normalTargets, 2);
                let p1GuardAttacks1 = this.getRandomItems(this.normalAttacks, 2);
                let p1GuardAttacks2 = this.getRandomItems(this.normalAttacks, 2);

                //this.addLog(`${p2Name} 狙う部位：${p2Target} 攻撃方法：1回目${p2Attacks[0]}、2回目${p2Attacks[1]} / ${p1Name} 警戒部位：[${p1Guards.join('、')}] 警戒攻撃方法：1回目[${p1GuardAttacks1.join('、')}] 2回目[${p1GuardAttacks2.join('、')}]`);

                // 攻撃判定
                let p1Success = this.calculateAttackSuccess(p1Target, p1Attacks, p2Guards, p2GuardAttacks1, p2GuardAttacks2);
                let p2Success = this.calculateAttackSuccess(p2Target, p2Attacks, p1Guards, p1GuardAttacks1, p1GuardAttacks2);

                if (p1Success > p2Success) {
                    await this.executeAttackPhase(p1Name, p2Name, p1Target, p1Attacks, p2Guards, p2GuardAttacks1, p2GuardAttacks2);
                } else if (p2Success > p1Success) {
                    await this.executeAttackPhase(p2Name, p1Name, p2Target, p2Attacks, p1Guards, p1GuardAttacks1, p1GuardAttacks2);
                } else {
                    //this.addLog(`${p1Name}と${p2Name}は睨み合っている...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            calculateAttackSuccess(attackTarget, attacks, guardTargets, guardAttacks1, guardAttacks2) {
                let success = 0;
                if (!guardTargets.includes(attackTarget)) {
                    if (!guardAttacks1.includes(attacks[0])) {
                        success++;
                        if (!guardAttacks2.includes(attacks[1])) {
                            success++;
                        }
                    }
                }
                return success;
            }

            async executeAttackPhase(attackerName, defenderName, target, attacks, guardTargets, guardAttacks1, guardAttacks2) {
                const isP1Attacker = attackerName === (document.getElementById('player1Name').value || 'Player 1');
                const defenderId = isP1Attacker ? 'p2' : 'p1';
                
                // 1撃目
                if (guardTargets.includes(target)) {
                    this.addLog(`${attackerName}は${target}を狙って${attacks[0]}したが、${defenderName}は${target}への攻撃を読み切って躱した。`);
                    return;
                }

                if (guardAttacks1.includes(attacks[0])) {
                    this.addLog(`${attackerName}は${target}を狙って${attacks[0]}したが、${defenderName}は${attacks[0]}攻撃を見切って躱した。`);
                    return;
                }

                this.addLog(`${attackerName}は${defenderName}の${target}に${attacks[0]}攻撃した。`);
                await new Promise(resolve => setTimeout(resolve, 500));

                // 2撃目
                if (this.previousSecondHitFailed[defenderId]) {
                    // 前ターンで2撃目を受けていた場合
                    this.addLog(`${attackerName}はさらに${defenderName}の${target}に${attacks[1]}攻撃した。${defenderName}は${attacks[1]}攻撃を見切っていたが、前回の攻撃の影響で防げなかった。`);
                    this.addLog(`${defenderName}はダウンした。`);
                } else {
                    if (guardAttacks2.includes(attacks[1])) {
                        this.addLog(`${attackerName}はさらに${target}を狙って${attacks[1]}したが、${defenderName}は${attacks[1]}への攻撃を読み切って躱した。`);
                        // 2撃目失敗フラグを立てる
                        this.previousSecondHitFailed[defenderId] = true;
                        return;
                    }
                    this.addLog(`${attackerName}はさらに${defenderName}の${target}に${attacks[1]}攻撃した。`);
                    this.addLog(`${defenderName}はダウンした。`);
                }

                // 追い討ち
//                let followupTarget = this.getRandomItem(this.followupTargets);
//                let followupAttack = this.getRandomItem(this.followupAttacks);
                let followupCombo = this.getRandomItem(this.followupCombos); // 固定で最初のコンボを選択
                let followupTarget = followupCombo.target;
                let followupAttack = followupCombo.attack;                
                //this.addLog(`${attackerName} 狙う部位：${followupTarget} 攻撃方法：${followupAttack}`);
                this.addLog(`${attackerName}は${followupAttack}攻撃の準備のため技を出す部位を攻撃部位に当てがい、今からすることを察させた。`);
                this.addLog(`${attackerName}はダウンしている${defenderName}の${followupTarget}に${followupAttack}攻撃した。`);

                // ラウンド更新
                if (attackerName === document.getElementById('player1Name').value || attackerName === 'Player 1') {
                    this.rounds.p1++;
                } else {
                    this.rounds.p2++;
                }

                // ラウンド終了時にフラグをリセット
                this.previousSecondHitFailed.p1 = false;
                this.previousSecondHitFailed.p2 = false;
                
                if (this.rounds.p1 === 2 || this.rounds.p2 === 2) {
                    this.addLog(`${defenderName}は立ち上がれない。`);
                    this.addLog(`戦闘終了。`);

                    // フィニッシュ
//                    let finishTarget = this.getRandomItem(this.finishTargets);
//                    let finishAttack = this.getRandomItem(this.finishAttacks);
                let finishCombo = this.getRandomItem(this.finishCombos); // 固定で最初のコンボを選択
                let finishTarget = finishCombo.target;
                let finishAttack = finishCombo.attack;                
                    
                    //this.addLog(`${attackerName} 狙う部位：${finishTarget} 攻撃方法：${finishAttack}`);
                this.addLog(`${attackerName}は${finishAttack}攻撃の準備のため技を出す部位を攻撃部位に当てがい、今からすることを察させた。`);
                    this.addLog(`${attackerName}は最後に嫌がる${defenderName}の${finishTarget}に${finishAttack}攻撃した。`);
                    this.addLog(`${attackerName}は抵抗する${defenderName}の${finishTarget}にさらに${finishAttack}攻撃した。`);
                } else {
                    this.addLog(`${attackerName}はダウンしている${defenderName}を無理やり立たせた。`);
                    this.addLog(`戦闘再開。`);
                }

                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        const battleSystem = new BattleSystem();

        function startBattle() {
            battleSystem.startBattle();
        }
				
				function updatePlayerInfo(playerId) {
    const characterSelect = document.getElementById(`${playerId}CharacterSelect`);
    const genderSelect = document.getElementById(`${playerId}GenderSelect`);
		const typeSelect = document.getElementById(`${playerId}TypeSelect`);
    const playerNameInput = document.getElementById(`${playerId}Name`);
    const imageElement = document.getElementById(`${playerId}Image`);

    // キャラクター名と性別と性格を取得
    const characterName = characterSelect.value;
    const gender = genderSelect.value;
		const type = typeSelect.value;

    // キャラクター名(性別)を自動設定
    if (characterName && gender && type) {
        playerNameInput.value = `${characterName} (${gender}/${type})`;

        // 画像を更新
        const imagePath = `./img/portrait/${characterName.replace(/\s/g, '_')}.webp`;
        imageElement.src = imagePath;
        imageElement.style.display = 'block';
    } else {
        playerNameInput.value = '';
        imageElement.style.display = 'none';
    }
}

function setRandomSettings(playerId) {
    const characterOptions = ['サナギ体',
'アラクネアワーム',
'ベルバーワーム',
'フォルミカアルビュスワーム',
'ジオフィリドワーム',
'アキャリナワーム',
'ランピリスワーム',
'コキリアワーム',
'エピラクナワーム',
'キャマラスワーム',
'ジェノミアスワーム',
'ミュスカワーム',
'ビエラワーム',
'プレクスワーム',
'レプトーフィスワーム',
'グリラスワーム',
'カッシスワーム',
'シシーラワーム',
'フォリアタスワーム',
'コレオプテラワーム',
'ベルクリネタスワーム'];
    const genderOptions = ['雄', '雌'];
    const typeOptions = [
        '好戦的で戦闘狂',
        '好戦的で支配的',
        '好戦的で紳士的',
        '非好戦的で卑怯',
        '非好戦的で冷酷',
        '非好戦的で慈愛'
    ];

    // ランダムな値を選択
    const randomCharacter = characterOptions[Math.floor(Math.random() * characterOptions.length)];
    const randomGender = genderOptions[Math.floor(Math.random() * genderOptions.length)];
    const randomType = typeOptions[Math.floor(Math.random() * typeOptions.length)];

    // セレクト要素を更新
    document.getElementById(`${playerId}CharacterSelect`).value = randomCharacter;
    document.getElementById(`${playerId}GenderSelect`).value = randomGender;
    document.getElementById(`${playerId}TypeSelect`).value = randomType;

    // プレイヤー情報を更新
    updatePlayerInfo(playerId);
}

// バトルログをクリップボードにコピーする関数
function copyBattleLog() {
    const battleLog = document.getElementById('battleLog').value;

    // 任意のテキストをバトルログの先頭に追加
    const headerText = "次のシーンを1つずつ書いてください。最初の5つを書いてください。";
    const modifiedLog = `${headerText}\n\n${battleLog}`; // 1行空ける

    // クリップボードにコピー
    navigator.clipboard.writeText(modifiedLog).then(() => {
        alert("バトルログをコピーしました！");
    }).catch(err => {
        console.error("コピーに失敗しました:", err);
    });
}

// 定型文をクリップボードにコピーする関数
function copyTemplateText(templateId) {
    let templateText = "";

    // 定型文を指定
    switch (templateId) {
        case 1:
            templateText = "・攻撃側の部位状態には感触を、モーションはどこをどうするかを記載し、受け手側のモーションには苦痛に悶え喘ぐ様を追加してください。 ・全てのワームは人間を襲う種族で恐怖を感じず、丈夫なため余程のことがない限りは呼吸困難や意識を失ったり、完全に壊死することはありません。また、敗北を認めません。 ダメージを受ける側のモーションは、両手で腹を押さえる、膝をつく、など、ダメージを受けた後の体の動作を書いてください。・察させる際は攻撃部位に触れさせてください。・双方のワームの性別と性格を考慮してください。性格は最後まで変わりません。01から05まで書き直して下さい。";
            break;
        case 2:
            templateText = "・攻撃側の部位状態には感触を、モーションはどこをどうするかを記載し、受け手側のモーションには苦痛に悶え喘ぐ様を追加してください。 ・全てのワームは人間を襲う種族で恐怖を感じず、丈夫なため余程のことがない限りは呼吸困難や意識を失ったり、完全に壊死することはありません。また、敗北を認めません。 ダメージを受ける側のモーションは、両手で腹を押さえる、膝をつく、など、ダメージを受けた後の体の動作を書いてください。・双方は仲間です。・双方のワームの性別と性格と関係性を考慮してください。性格は最後まで変わりません。01から05まで書き直して下さい。";
            break;
        case 3:
            templateText = "別ファイルにして続けてください。";
            break;
        default:
            console.error("無効なテンプレートIDです");
            return;
    }

    // クリップボードにコピー
    navigator.clipboard.writeText(templateText).then(() => {
        alert(`定型文${templateId}をコピーしました！`);
    }).catch(err => {
        console.error("コピーに失敗しました:", err);
    });
}
    </script>
</body>
</html>